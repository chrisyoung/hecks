#!/bin/bash
DATABASE_URL='mysql2://root:password@localhost/pizza_builder_test'
BINARY='./pizza_builder Pizzas create'
BINARY_ATTRIBUTES='{"name":"White Pizza","description":"white sauce and chicken","chef":{"name":"Chef Ramsey"},"toppings":[{"name":"chicken"}]}'
SERVERLESS_COMMAND='serverless invoke local -f pizza_builder -d'
set -ex

HECKS_DIR=`pwd`
PIZZA_BUILDER_DIR='hecks-examples/pizza_builder'

bash bin/build
bash bin/install

cd $PIZZA_BUILDER_DIR
hecks new
cd $HECKS_DIR
rspec -f d

cd $PIZZA_BUILDER_DIR
hecks package binary -c false
cd packages/binary/build/osx
DATABASE_URL=$DATABASE_URL $BINARY "$BINARY_ATTRIBUTES"

cd $HECKS_DIR

cd $PIZZA_BUILDER_DIR
hecks package lambda
cd packages/lambda/
DATABASE_URL=$DATABASE_URL $SERVERLESS_COMMAND "{\"module\": \"Pizzas\", \"method\": \"create\", \"data\": $BINARY_ATTRIBUTES}"
set +ex
