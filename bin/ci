#!/bin/bash
DATABASE_URL='mysql2://root:password@localhost/pizza_builder_test'
BINARY='./pizza_builder Pizzas create'
BINARY_ATTRIBUTES='{"name":"White Pizza","description":"white sauce and chicken","chef":{"name":"Chef Ramsey"},"toppings":[{"name":"chicken"}]}'
LAMBDA_ATTRIBUTES="{'module': 'Pizzas', 'method': 'create', 'data': '$BINARY_ATTRIBUTES'}"

HECKS_DIR=`pwd`
PIZZA_BUILDER_DIR='hecks-examples/pizza_builder'

# Hecks
bash bin/build
cd $PIZZA_BUILDER_DIR
hecks new
cd $HECKS_DIR
rspec -f d

cd $PIZZA_BUILDER_DIR
hecks package binary -c false
cd packages/binary/build/osx
DATABASE_URL=$DATABASE_URL $BINARY "$BINARY_ATTRIBUTES"

cd $HECKS_DIR

# Lambda Package
cd $PIZZA_BUILDER_DIR
hecks package lambda
cd packages/lambda/
DATABASE_URL=$DATABASE_URL serverless invoke local -f pizza_builder -d "{\"module\": \"Pizzas\", \"method\": \"create\", \"data\": $BINARY_ATTRIBUTES}"
